---
title: "What is a CA and how to use it"
author: "Capucine, Marion et Maite"
editor: visual
---

# Introduction

A Correspondence Analysis (CA), or "Analyse Factorielle de Correspondance" (AFC) in French, is a multivariate statistical method used to measure the distance between different profiles in your data, or the discrepancy between the data and the chi-square $\chi²$ independence hypothesis. This hypothesis (also called the null hypothesis H0) implies that the 2 variables studied are independent.

The values can be quantitative, qualitative or semi-qualitative. It is usually applied to contingency tables or when you have a table with data about species abundance in different places and another one with data about the ecology of those same places.

Just like in the PCA, we will be looking the orthogonal axis that maximizes the inertia. The parameter used is the $\chi²$ distance : this distance is calculated between 2 rows or 2 columns. The AFC gives a weight to each profile, proportional to the abundance of the profile.

The columns and lines have a symmetrical role, so you'll have the same results in both directions.

To use it you'll need to pay attention to certain things :

-   all values need to be positive (which shouldn't be a problem if it's a contingency table),

-   if you have rare species it may change the shape of your results significantly. It's not always a bad thing, just something you need to be aware of.

# Ecological context

A study was conducted in 2022 on the wetlands of the municipality of Grabels (34), as part of a Municipal Biodiversity Atlas. The aim was to characterise the state of these environments using bioindicator species : benthic macroinvertebrates. This taxon, which is sensitive to pollution, can be used to study water quality (ref).\
In this study, two streams (the Rieu Querelle and the Verdanson), permanent ponds and an artificial water source (the retention basin) were sampled and the individuals identified. Each wetland was sampled at several points randomly selected from the water body, and three passes were made at each point.

The purpose of this analysis is to study the species assemblages depending of the site. In this context, the AFC is one of the right choices.

#### Imports

```{r}
rm(list = ls())
#imports
#install.packages("dplyr")
library(dplyr)
library(readr)
library(stringi)

#Import data
macroinv <- read.csv("ABC_macroinv.csv", header = TRUE, fileEncoding = "latin1", sep = ";")

classification <- read_delim(
  "classif_macroinv.csv",
  delim = ";",
  col_names = FALSE,              
  locale = locale(encoding = "latin1"),
  name_repair = "minimal"
)

#replace colnames in both dataframes
colnames(macroinv) <- colnames(macroinv) %>%
                  stri_trans_general("Latin-ASCII") %>% 
                  gsub("\\.", "_", .) %>%
                  gsub("[^A-Za-z0-9_]", "", .)

classification <- classification %>%
  mutate(across(everything(), \(x)
                x %>%
                  stri_trans_general("Latin-ASCII") %>% 
                  gsub(" ", "_", .) %>%
                  gsub("[^A-Za-z0-9_]", "", .)
                ))

head(macroinv) ; head(classification)
```

#### Reduce the size of the data frame to remove rare species (\<1):

```{r}
#check each specie count
species_sum = colSums(macroinv[,-c(1,2)])

#keep only names of species with <1 occurences
species_keep <- names(species_sum[species_sum > 1])

#create reduced dataframe
macroinv_red <- macroinv[, c(names(macroinv)[1:2], species_keep)]
```

#Analysis

```{r}
library(FactoMineR)
library(ade4)
```

```{r}
CA <- CA(macroinv_red[,-c(1,2)])
CA <- CA(macroinv_red[,-c(1,2)], axes = c(3,4))
plot(CA$eig[,2], type = "h")

CA$col$contrib
CA$row
```

```{r}
CA_ade4 <- dudi.coa(macroinv_red[,-c(1,2)],scannf=FALSE,nf=60)
CA_ade4
barplot(CA_ade4$eig)

pourcentage <- CA_ade4$eig/sum(CA_ade4$eig)*100
pourcentage #pourcentage d'inertie expliquée selon les axes

round(cumsum(pourcentage),2) #inertie cumulée
```

```{r}
scatter(CA_ade4, posieig = "none")
s.label(CA_ade4$li, xax = 3, yax = 4, boxes = FALSE)
s.label(CA_ade4$co, xax = 3, yax = 4, boxes = FALSE)
```

Les axes ont peu d'inertie (mais bon c'est de l'écologie)

Représentation du diagramme avec les trajectoires

```{r}
s.traject(CA_ade4$li)
s.traject(CA_ade4$li)

```

Pas très lisible, refaire en enlevant les points qui sont très loins?

```{r}
table.value(macroinv_red[,-c(1,2)][order(CA_ade4$li[,1]),order(CA_ade4$co[,1])], grid=T,csize=0.5,clabel.col=0.6)
```

Distribution des espèces

```{r}
esp = 22 #esp dans le bassin isolé des autres données
esp = 23 #esp un peu partout
s.distri(CA_ade4$li,macroinv_red[,esp],cell=1.5,sub=macroinv_red[1,esp],csub=2)
```

Distribution des sites

```{r}
site = 3
s.distri(CA_ade4$co,macroinv_red[site],cell=1.5,csub=2)
```
