---
title: "GENERALIZED LINEAR MIXED MODEL"
subtitle: "BADGER EXAMPLE"
format: html
editor: visual
bibliography: references.bib
---

# GENERAL INTRODUCTION

### Generalities

General Linear Models are used to describe the relationship between a continuous response $Y$ and one or more explanatory variables $X_{1}$,$X_{2}$...$X_{p}$. They rely on three main assumptions : *independence of residuals*, *normality of residuals* and *homogeneity of variances*. However, in many cases, the response variable $Y$ is **discrete** (for example, counts or binary outcomes).

For discrete responses, the variance of $Y$ typically depends on its mean-variance relationship. As a result, the variance is not constant across observations, invalidating the assumption of homogeneity required by linear models. Morover, fitting a General Linear Model to count data can lead to negative predicted values and non-normal residuals. In shorts, General Linear Models are not well-suited for discrete responses. Hence, we need specific tools to analyse discrete response data. These are **Generalized Linear Models (GLMs)**.

### Structure of a Generalized Linear Model

A GLM extends the classical linear model through three steps :

1.  Assumption of the distribution of the response variable $Y_{i}$

2.  The specification of the systematic part; this is the linear function of the explanatory variables (the linear predictor called $\eta$)

3.  The relationship between the mean value of $Y_{i}$ and the systematic part. This is also called the link between the mean and the systematic part: **the link function noted** $g$ .

A Generalized Linear Model can be written as : $$g(\mu_{y})= \alpha+ \beta_{1}.X{i1}+ \beta_{2}.X{i2}+\beta_{3}.X{i3}+...\beta_{p}.X{ip} = \eta $$

The linear predictor, $\eta$, emerges from the linear model as a sum of the terms for each of the $p$ parameters. This is not a value of $Y$. The value of $\eta$ is obtained by transforming the value of $Y$ by the link function, and the predicted value of $Y$ is obtained by applying the inverse link function to $\eta$.

### From GLM to GLMM

Depending on the sampling design or the experimental set-up, independence of residuals is often not respected : some statistical units are related. To account for this dependence structure, we can include **random effects** in the model.

The resulting model, called Generalized Linear Mixed Model (GLMM) extends the GLM by adding these random effects alongside the fixed effects. Therefore, GLMMs allow us to model both the relationship between predictors and responses and the non-independence among observations.

## Data presentation

The data used come from Zuur *et al.* (2019) and consist of signs of badger (*Meles meles*) activity around farms located in the southwest of England, where badger density is high. This study was carried out in the context of bovine tuberculosis and its possible transmission to cattle through badgers. Reducing the number of farm visits by badgers — especially in places where they might come into contact with livestock — could help limit the spread of the disease. Thus, the aim of this study is to predict the occurrence of badger activity signs on farms.

Between autumn 2003 and summer 2005, a survey was conducted on 36 different farms; the data are therefore longitudinal, since each farm was monitored over eight consecutive seasons. Within the same farm, observations may be temporally autocorrelated.

The response variable (presence or absence of signs of badger activity) is binary: it takes the value 1 when signs of activity were detected, and 0 otherwise. Signs of activity include the presence of feces, setts, or feeding traces.

The data are available in the file `BadgersFarmSurveysNoNA.txt`. The variables are:

-   `Year` : studied year
-   `Season` : 1 = spring, 2 = summer, 3 = autumn, 4 = winter
-   `farm_code_numeric` : farm identifier
-   `Survey` : survey identifier (time indicator)
-   `Signs_in_yard` : binary indicator of badger activity (response variable)
-   `No_setts_in_fields` : number of setts
-   `No_active_setts_in_fields` : number of actively occupied setts
-   `No_buildings` : number of buildings in the farm
-   `No_cattle_in_buildings_yard` : number of cattle in building yards
-   `Accessible_feed_store_present` : presence / absence of an accessible feed store
-   `Accessible_cattle_house_present` : presence / absence of a direct access to the cattle house
-   `Accessible_feed_present` : presence / absence of accessible feed in the farm
-   `Grass_silage` : presence / absence of grass silage
-   `Cereal_silage` : presence / absence of cereal silage
-   `HayStraw` : presence / absence of hay and / or straw
-   `Cereal_grains` : presence / absence of cereal grains
-   `Concentrates` : presence / absence of concentrates
-   `Proteinblocks` : presence / absence of protein blocks
-   `Sugarbeet` : presence / absence of sugar beet
-   `Vegetables` : presence / absence of vegetables
-   `Molasses` : presence / absence of molasses :::

## DATASET IMPORT

```{r}
# library import
library(corrplot)
```

```{r global data, include=TRUE,echo=TRUE}
# Dataset import
dataBadger <- read.table("Badger.txt", dec=".", header = TRUE)

# Reduce name and change categorical variables as factor
dataBadger$Activity<- dataBadger$signs_in_yard
dataBadger$N_setts<-dataBadger$N_setts_in_fields
dataBadger$N_cattle<-dataBadger$N_cattle_in_buildings_yard
dataBadger$season<-as.factor(dataBadger$season)
dataBadger$feed_store<-as.factor(dataBadger$accessible_feed_store_present)
dataBadger$cattle_house<-as.factor(dataBadger$accessible_cattle_house_present)
dataBadger$feed<-as.factor(dataBadger$accessible_feed_present)
dataBadger$grass<-as.factor(dataBadger$grass_silage)
dataBadger$cereal<-as.factor(dataBadger$cereal_silage)
dataBadger$straw<-as.factor(dataBadger$hay_straw)
dataBadger$grains<-as.factor(dataBadger$cereal_grains)
dataBadger$concen<-as.factor(dataBadger$concentrates)
dataBadger$sugar<-as.factor(dataBadger$sugar_beet)
dataBadger$molasses<-as.factor(dataBadger$molasses)

# Check for presence of missing values
colSums(is.na(dataBadger))
# There is no missing value.
```

## DATA EXPLORATION

Before any statistical analysis, you need to explore the data in order to prevent any error. Here is the list of exploration to perform before modelling:

1.  Check presence of outliers in $Y$ and distribution of $Y$ values
2.  If $X$ is a quantitative independent variable, check presence of outliers in X and distribution of X values\
    2b. If $X$ is a qualitative independent variable, analyse the number of levels and the number of individuals per level
3.  Analyse the potential relationships between $Y$ and the $X_{s}$
4.  Check presence of interactions between $X_{s}$
5.  Check presence of collinearity between $X_{s}$

### Outliers in $Y$ and distribution of $Y$

As $Y$ is a binary variable, there is no distribution. However, we could inspect how many 0 and 1 we have.

```{r dataY, include=TRUE}
# Number of 0 and 1 in Y
table(dataBadger$Activity)
```

### For the $Xs$ that are quantitative : check outliers and Xs distribution

```{r dataCov, include=TRUE, fig.height=8, fig.width=8}
par(mfrow=c(3,3))

# Number of badger setts on farm
# Cleveland plot
dotchart(dataBadger$N_setts,pch=16,col='blue',xlab='Number of setts')
# Histogram
hist(dataBadger$N_setts,col='blue',xlab="Number of setts",main="")
# Quantile-Quantile plot
qqnorm(dataBadger$N_setts,pch=16,col='blue',xlab='')
qqline(dataBadger$N_setts,col='red')

# Number of buildings on farm
# Cleveland plot
dotchart(dataBadger$N_buildings,pch=16,col='blue',xlab='Number of buildings')
# Histogram
hist(dataBadger$N_buildings,col='blue',xlab="Number of buildings",main="")
# Quantile-Quantile plot
qqnorm(dataBadger$N_buildings,pch=16,col='blue',xlab='')
qqline(dataBadger$N_buildings,col='red')

# Number of cattle housed in buildings on farm
# Cleveland plot
dotchart(dataBadger$N_cattle,pch=16,col='blue',xlab='Number of cattle')
# Histogram
hist(dataBadger$N_cattle,col='blue',xlab="Number of cattle",main="")
# Quantile-Quantile plot
qqnorm(dataBadger$N_cattle,pch=16,col='blue',xlab='')
qqline(dataBadger$N_cattle,col='red')
```
<<<<<<< HEAD

For this $X$ continuous independent variable we don't see obvious outliers. And we can see the different distributions of the variables.

### For $Xs$ that are categorical : number of levels and number of individuals per level

```{r datafact, include=TRUE}
# Factor season
summary(dataBadger$season)
# Factor feed_store
summary(dataBadger$feed_store)
# Factor cattle_house 
summary(dataBadger$cattle_house )
# Factor feed
summary(dataBadger$feed)
# Factor grass
summary(dataBadger$grass)
# Factor cereal
summary(dataBadger$cereal)
# Factor straw
summary(dataBadger$straw)
# Factor grains
summary(dataBadger$grains)
# Factor concen
summary(dataBadger$concen)
# Factor sugar
summary(dataBadger$sugar)
```

Make conclusion about these $X$ categorical independent variables

### Analysis of the potential relationships Y vs Xs

To better understand the relationships between the response variable (*Activity*) and the predictors, both quantitative and categorical variables were explored graphically.\

Scatterplots were used to visualize the relationship between *Activity* and continuous predictors, while mosaic plots were employed to examine associations between *Activity* and categorical predictors.\

These visual analyses provide a first impression of potential patterns, dependencies, or nonlinear relationships that may influence badger activity on farms.

```{r datagraph, include=TRUE, fig.height=5, fig.width=10}

par(mfrow=c(1,3))
# Number of setts
plot(dataBadger$Activity~dataBadger$N_setts,pch=16,col='blue',xlab='Number of setts',ylab='Presence of a sign of badger activity')

# Number of buildings
plot(dataBadger$Activity~dataBadger$N_buildings,pch=16,col='blue',xlab='Number of buildings',ylab='Presence of a sign of badger activity')

# Number of cattle housed in buildings
plot(dataBadger$Activity~dataBadger$N_cattle,pch=16,col='blue',xlab='Number of cattle',ylab='Presence of a sign of badger activity')

par(mfrow=c(2,5))
# Factor season
mosaicplot(dataBadger$Activity~dataBadger$season
           ,color=c('blue3','red2')
           ,main="Activity & Season")

# Factor feed store
mosaicplot(dataBadger$Activity~dataBadger$feed_store
           ,color=c('blue3','red2')
           ,main="Activity & Feed store")

# Factor cattle_house 
mosaicplot(dataBadger$Activity~dataBadger$cattle_house
           ,color=c('blue3','red2')
           ,main="Activity & cattle house")

# Factor feed
mosaicplot(dataBadger$Activity~dataBadger$feed
           ,color=c('blue3','red2')
           ,main="Activity & feed")
# Factor grass
mosaicplot(dataBadger$Activity~dataBadger$grass
           ,color=c('blue3','red2')
           ,main="Activity & Grass")
# Factor cereal
mosaicplot(dataBadger$Activity~dataBadger$cereal
           ,color=c('blue3','red2')
           ,main="Activity & Cereal")
# Factor straw
mosaicplot(dataBadger$Activity~dataBadger$straw
           ,color=c('blue3','red2')
           ,main="Activity & Straw")
# Factor grains
mosaicplot(dataBadger$Activity~dataBadger$grains
           ,color=c('blue3','red2')
           ,main="Activity & Grains")
# Factor concen
mosaicplot(dataBadger$Activity~dataBadger$concen
           ,color=c('blue3','red2')
           ,main="Activity & Concentrates")
# Factor sugar
mosaicplot(dataBadger$Activity~dataBadger$sugar
           ,color=c('blue3','red2')
           ,main="Activity & Sugar Beet")
```

Make conclusion about these graphics

### Analysis of possible interactions between both independent variables

Here, given the large number of predictors, we will not include interactions in modelling

### Check for colinearity between Xs

In order to prevent collinearity in the modelling, we will analyse how the predictor variables are related. First, we will check (1) correlation between the three quantitative independent variables, (2) how the factors are crossed and (3) then, we estimate whether these categorical predictors influence the both quantitative ones by using boxplot graphics. Given the large number of predictors, this analysis of collinearity is partially detail below.

```{r datacolin, include=TRUE, fig.height=5, fig.width=5}

# Checking collinearity between the 3 quantitative independent variables

# We represent plot for each X continuous covariate pairs
plot(dataBadger[7:9],pch=16,col='blue')

#We calculate correlation between each pair of X covariate
M<-cor(dataBadger[7:9])
corrplot.mixed(M,upper="square",lower.col="black", tl.col="black",cl.cex = 0.8,tl.cex = 0.7,number.cex =0.8)

# Checking collinearity between  categorical independent variables
# produce all crossed tables between pairs of factors - not detailed here

# Checking collinearity between categorical and quantitative independent variables
# for each quantitative independent variable, use boxplot graphics to check whether factors influence it - not detailed here
```

A weak collinearity between both quantitative variables is possible (N buildings and N cattle housed). No other case of collinearity has been found (not developed here).

## Generalized Linear Mixed Model (GLMM)
### Building the model
```{r}
library(lme4)
mod<-glmer(Activity~N_setts
              + N_buildings
              + N_cattle
              + season
              + feed_store
              + cattle_house
              + feed
              + grass
              + cereal
              + straw
              + grains
              + concen
              + sugar
              + (1|farm_code)
              ,data=data
              ,family=binomial)
```

